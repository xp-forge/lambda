FROM public.ecr.aws/lambda/provided:al2 as builder

ARG php_version="?.?.?"
ARG xp_version="?.?.?"

RUN yum clean all && yum install -y \
  autoconf \
  gcc \
  gcc-c++ \
  make \
  re2c \
  openssl-devel \
  libxml2-devel \
  tar \
  gzip \
  zip \
  bison

# Build PHP
RUN curl -L https://github.com/php/php-src/archive/php-${php_version}.tar.gz | tar -xvz

RUN cd php-src-php-${php_version} && ./buildconf --force && ./configure \
  --prefix=/opt/php/ \
  --without-sqlite3 \
  --with-zlib \
  --with-openssl \
  --enable-bcmath \
  --disable-pdo && \
  make -j $(nproc) all install

# Create XP Bootstrap
RUN curl -L https://github.com/xp-runners/reference/releases/download/v${xp_version}/xp-run-${xp_version}.sh \
  | sed -e 's/"$@"/xp.lambda.AwsRunner/g' > /opt/php/bootstrap \
  && chmod 755 /opt/php/bootstrap \
  && head -1 /opt/php/bootstrap | grep '^#!'

RUN echo "memory_limit=-1" > /opt/php/bin/php.ini

RUN cd /opt/php && strip bin/php && zip -9 runtime.zip bin/php bin/php.ini bootstrap